<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Functional Deployment Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e1e5e9;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-left: 4px solid #3498db;
        }

        .card-title {
            font-size: 1.4em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            margin: 8px 8px 8px 0;
            transition: all 0.3s ease;
            color: white;
        }

        .btn-primary { background: linear-gradient(135deg, #3498db, #2980b9); }
        .btn-success { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .btn-warning { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .btn-danger { background: linear-gradient(135deg, #e74c3c, #c0392b); }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .output {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            display: none;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .info-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .info-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
        }

        .info-label {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .test-section h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Functional Deployment Manager</h1>
            <p>Real server testing and diagnostics for IeNet production deployment</p>
            <p><strong>Domain:</strong> <span id="current-domain">ienet.online</span> | <strong>Status:</strong> <span id="overall-status">Testing...</span></p>
        </div>

        <div class="grid">
            <!-- Quick Status Card -->
            <div class="card">
                <div class="card-title">‚ö° Quick Status Check</div>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-value" id="domain-ping">?</div>
                        <div class="info-label">Domain</div>
                    </div>
                    <div class="info-item">
                        <div class="info-value" id="api-ping">?</div>
                        <div class="info-label">API</div>
                    </div>
                    <div class="info-item">
                        <div class="info-value" id="db-ping">?</div>
                        <div class="info-label">Database</div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="runQuickTest()">üîç Quick Test</button>
                <button class="btn btn-success" onclick="runFullTest()">üöÄ Full Test</button>
                <div class="status" id="quick-status"></div>
            </div>

            <!-- Domain Testing -->
            <div class="card">
                <div class="card-title">üåê Domain & Website Testing</div>
                <button class="btn btn-primary" onclick="testDomainAccess()">Test Domain Access</button>
                <button class="btn btn-success" onclick="testWebsiteContent()">Test Website Content</button>
                <button class="btn btn-warning" onclick="testSSLCertificate()">Check SSL Certificate</button>
                <div class="status" id="domain-status"></div>
                <div class="output" id="domain-output"></div>
            </div>

            <!-- API Testing -->
            <div class="card">
                <div class="card-title">üîå API Endpoints Testing</div>
                <button class="btn btn-primary" onclick="testAPIHealth()">Test Health Endpoint</button>
                <button class="btn btn-success" onclick="testAPIEndpoints()">Test All Endpoints</button>
                <button class="btn btn-warning" onclick="testAPIResponse()">Test API Response</button>
                <div class="status" id="api-status"></div>
                <div class="output" id="api-output"></div>
            </div>

            <!-- Database Testing -->
            <div class="card">
                <div class="card-title">üõ¢Ô∏è Database Connection Testing</div>
                <button class="btn btn-primary" onclick="testDatabaseViaAPI()">Test DB via API</button>
                <button class="btn btn-success" onclick="checkDatabaseTables()">Check Tables</button>
                <button class="btn btn-warning" onclick="testServiceCategories()">Test Service Data</button>
                <div class="status" id="db-status"></div>
                <div class="output" id="db-output"></div>
            </div>

            <!-- Server Diagnostics -->
            <div class="card">
                <div class="card-title">üñ•Ô∏è Server Diagnostics</div>
                <button class="btn btn-primary" onclick="checkServerStatus()">Check Server Status</button>
                <button class="btn btn-success" onclick="testServerResponse()">Test Server Response</button>
                <button class="btn btn-danger" onclick="diagnoseErrors()">Diagnose 502 Errors</button>
                <div class="status" id="server-status"></div>
                <div class="output" id="server-output"></div>
            </div>

            <!-- Comprehensive Report -->
            <div class="card full-width">
                <div class="card-title">üìä Deployment Status Report</div>
                <button class="btn btn-primary" onclick="generateReport()">Generate Full Report</button>
                <button class="btn btn-success" onclick="checkDeploymentHealth()">Deployment Health Check</button>
                <button class="btn btn-warning" onclick="showTroubleshooting()">Troubleshooting Guide</button>
                <div class="status" id="report-status"></div>
                <div class="output" id="report-output"></div>
            </div>
        </div>
    </div>

    <script>
        const DOMAIN = 'https://www.ienet.online';
        const TIMEOUT = 10000; // 10 seconds

        // Global test results storage
        let testResults = {
            domain: null,
            api: null,
            database: null,
            server: null,
            timestamp: null
        };

        // Utility functions
        function showStatus(elementId, message, type = 'info', autohide = true) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            element.className = `status ${type}`;
            element.textContent = message;
            element.style.display = 'block';
            
            if (autohide) {
                setTimeout(() => {
                    element.style.display = 'none';
                }, 8000);
            }
        }

        function showOutput(elementId, content) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            element.textContent = content;
            element.style.display = 'block';
        }

        function updateQuickStatus(domain, api, db) {
            document.getElementById('domain-ping').textContent = domain || '?';
            document.getElementById('api-ping').textContent = api || '?';
            document.getElementById('db-ping').textContent = db || '?';
        }

        function setLoading(buttonElement, isLoading) {
            if (isLoading) {
                buttonElement.disabled = true;
                buttonElement.style.opacity = '0.6';
                buttonElement.textContent = buttonElement.textContent.replace(/^[üîçüöÄ‚ö°üåêüîåüõ¢Ô∏èüñ•Ô∏èüìä]/, '‚è≥');
            } else {
                buttonElement.disabled = false;
                buttonElement.style.opacity = '1';
            }
        }

        // Timeout wrapper for fetch requests
        async function fetchWithTimeout(url, options = {}) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), TIMEOUT);
            
            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error('Request timeout (10s)');
                }
                throw error;
            }
        }

        // Quick Test Function
        async function runQuickTest() {
            const button = event.target;
            setLoading(button, true);
            showStatus('quick-status', 'Running quick connectivity test...', 'info');
            
            let domainOk = false, apiOk = false, dbOk = false;

            try {
                // Test domain
                const domainResp = await fetchWithTimeout(DOMAIN);
                domainOk = domainResp.ok;
                updateQuickStatus(domainOk ? '‚úÖ' : '‚ùå', '?', '?');
            } catch (e) {
                updateQuickStatus('‚ùå', '?', '?');
            }

            try {
                // Test API
                const apiResp = await fetchWithTimeout(`${DOMAIN}/api/health`);
                apiOk = apiResp.ok;
                updateQuickStatus(domainOk ? '‚úÖ' : '‚ùå', apiOk ? '‚úÖ' : '‚ùå', '?');
            } catch (e) {
                updateQuickStatus(domainOk ? '‚úÖ' : '‚ùå', '‚ùå', '?');
            }

            try {
                // Test database via service categories
                const dbResp = await fetchWithTimeout(`${DOMAIN}/api/service-categories`);
                dbOk = dbResp.ok;
                updateQuickStatus(domainOk ? '‚úÖ' : '‚ùå', apiOk ? '‚úÖ' : '‚ùå', dbOk ? '‚úÖ' : '‚ùå');
            } catch (e) {
                updateQuickStatus(domainOk ? '‚úÖ' : '‚ùå', apiOk ? '‚úÖ' : '‚ùå', '‚ùå');
            }

            const overallStatus = domainOk && apiOk && dbOk ? 'All Systems OK' : 
                                 domainOk && apiOk ? 'Domain & API OK, DB Issues' :
                                 domainOk ? 'Domain OK, API/DB Issues' : 'Multiple Issues';
            
            document.getElementById('overall-status').textContent = overallStatus;
            
            showStatus('quick-status', 
                `Quick test complete: Domain ${domainOk ? 'OK' : 'FAIL'}, API ${apiOk ? 'OK' : 'FAIL'}, DB ${dbOk ? 'OK' : 'FAIL'}`, 
                (domainOk && apiOk && dbOk) ? 'success' : 'error');
            
            setLoading(button, false);
            button.textContent = 'üîç Quick Test';
        }

        // Domain Testing Functions
        async function testDomainAccess() {
            const button = event.target;
            setLoading(button, true);
            showStatus('domain-status', 'Testing domain access...', 'info');

            try {
                const response = await fetchWithTimeout(DOMAIN);
                const text = await response.text();
                const isHTML = text.includes('<!DOCTYPE html>') || text.includes('<html');
                const hasIeNetContent = text.includes('IeNet') || text.includes('India Espectacular');

                if (response.ok && isHTML) {
                    showStatus('domain-status', `Domain accessible: ${response.status} ${response.statusText}`, 'success');
                    showOutput('domain-output', `Domain Access Test Results:
‚úÖ HTTP Status: ${response.status} ${response.statusText}
‚úÖ Content Type: ${response.headers.get('content-type')}
‚úÖ Response Size: ${text.length} characters
‚úÖ HTML Content: ${isHTML ? 'Yes' : 'No'}
‚úÖ IeNet Content: ${hasIeNetContent ? 'Yes' : 'No'}
‚úÖ Server: ${response.headers.get('server') || 'Unknown'}

Sample content:
${text.substring(0, 300)}...`);
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                showStatus('domain-status', `Domain access failed: ${error.message}`, 'error');
                showOutput('domain-output', `Domain Access Error:
‚ùå Error: ${error.message}
‚ùå This could indicate:
  - DNS resolution issues
  - Server downtime
  - Network connectivity problems
  - SSL/TLS certificate issues

Troubleshooting:
1. Check DNS: nslookup ienet.online
2. Check ping: ping ienet.online
3. Check port: telnet ienet.online 443`);
            }

            setLoading(button, false);
            button.textContent = 'Test Domain Access';
        }

        async function testWebsiteContent() {
            const button = event.target;
            setLoading(button, true);
            showStatus('domain-status', 'Testing website content...', 'info');

            try {
                const response = await fetchWithTimeout(DOMAIN);
                const html = await response.text();
                
                // Extract key information
                const title = html.match(/<title>(.*?)<\/title>/i)?.[1] || 'Not found';
                const hasAssets = html.includes('/assets/') || html.includes('index-') && html.includes('.js');
                const hasReactRoot = html.includes('id="root"') || html.includes('id="app"');
                
                showStatus('domain-status', 'Website content analysis complete', 'success');
                showOutput('domain-output', `Website Content Analysis:
‚úÖ Page Title: ${title}
‚úÖ React Root Element: ${hasReactRoot ? 'Found' : 'Not found'}
‚úÖ Asset Links: ${hasAssets ? 'Found' : 'Not found'}
‚úÖ Content Length: ${html.length} characters

Meta Information:
${html.match(/<meta[^>]*>/g)?.slice(0, 3)?.join('\n') || 'No meta tags found'}

Script/Link Tags:
${html.match(/<script[^>]*src[^>]*>|<link[^>]*>/g)?.slice(0, 5)?.join('\n') || 'No external resources found'}`);
            } catch (error) {
                showStatus('domain-status', `Website content test failed: ${error.message}`, 'error');
                showOutput('domain-output', `Website Content Error: ${error.message}`);
            }

            setLoading(button, false);
            button.textContent = 'Test Website Content';
        }

        async function testSSLCertificate() {
            const button = event.target;
            setLoading(button, true);
            showStatus('domain-status', 'Checking SSL certificate...', 'info');

            try {
                const response = await fetchWithTimeout(DOMAIN);
                const protocol = window.location.protocol;
                const isSecure = protocol === 'https:' || DOMAIN.startsWith('https:');
                
                showStatus('domain-status', `SSL check complete - ${isSecure ? 'Secure' : 'Not secure'}`, isSecure ? 'success' : 'warning');
                showOutput('domain-output', `SSL Certificate Check:
‚úÖ Protocol: ${isSecure ? 'HTTPS (Secure)' : 'HTTP (Not Secure)'}
‚úÖ Connection: Successful
‚úÖ Response Status: ${response.status}
‚úÖ Security Headers: ${response.headers.get('strict-transport-security') ? 'HSTS Enabled' : 'HSTS Not Found'}

Note: Detailed SSL certificate information requires server-side tools.
For complete SSL analysis, use: openssl s_client -connect ienet.online:443`);
            } catch (error) {
                showStatus('domain-status', `SSL check failed: ${error.message}`, 'error');
                showOutput('domain-output', `SSL Certificate Error: ${error.message}`);
            }

            setLoading(button, false);
            button.textContent = 'Check SSL Certificate';
        }

        // API Testing Functions
        async function testAPIHealth() {
            const button = event.target;
            setLoading(button, true);
            showStatus('api-status', 'Testing API health endpoint...', 'info');

            try {
                const response = await fetchWithTimeout(`${DOMAIN}/api/health`);
                
                if (response.ok) {
                    const data = await response.json();
                    showStatus('api-status', 'API health endpoint is responding', 'success');
                    showOutput('api-output', `API Health Response:
‚úÖ Status: ${response.status} ${response.statusText}
‚úÖ Content-Type: ${response.headers.get('content-type')}
‚úÖ Response Time: < 10s

Response Data:
${JSON.stringify(data, null, 2)}`);
                } else {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
            } catch (error) {
                showStatus('api-status', `API health test failed: ${error.message}`, 'error');
                showOutput('api-output', `API Health Error:
‚ùå Error: ${error.message}
‚ùå This indicates:
  - Node.js server is not running
  - Server is not listening on port 3001
  - Nginx proxy configuration issues
  - 502 Bad Gateway errors

Check server logs:
ssh root@5.181.218.15
cd /var/www/vhosts/vivaindia.com/ienet.online/
cat server.log`);
            }

            setLoading(button, false);
            button.textContent = 'Test Health Endpoint';
        }

        async function testAPIEndpoints() {
            const button = event.target;
            setLoading(button, true);
            showStatus('api-status', 'Testing all API endpoints...', 'info');

            const endpoints = [
                { path: '/api/health', name: 'Health Check' },
                { path: '/api/auth/user', name: 'Authentication' },
                { path: '/api/service-categories', name: 'Service Categories' },
                { path: '/api/services', name: 'Services' },
                { path: '/api/projects', name: 'Projects' },
                { path: '/api/features', name: 'Features' }
            ];

            let results = [];
            let successCount = 0;

            for (const endpoint of endpoints) {
                try {
                    const response = await fetchWithTimeout(`${DOMAIN}${endpoint.path}`);
                    const success = response.ok || response.status === 401; // 401 is expected for auth
                    if (success) successCount++;
                    
                    results.push({
                        name: endpoint.name,
                        path: endpoint.path,
                        status: response.status,
                        statusText: response.statusText,
                        success: success
                    });
                } catch (error) {
                    results.push({
                        name: endpoint.name,
                        path: endpoint.path,
                        status: 'ERROR',
                        statusText: error.message,
                        success: false
                    });
                }
            }

            const overallSuccess = successCount >= endpoints.length * 0.7;
            showStatus('api-status', 
                `API test complete: ${successCount}/${endpoints.length} endpoints working`, 
                overallSuccess ? 'success' : 'error');
            
            showOutput('api-output', `API Endpoints Test Results:
${'='.repeat(50)}
${results.map(r => 
    `${r.name}: ${r.status} ${r.success ? '‚úÖ' : '‚ùå'} (${r.path})`
).join('\n')}

Summary:
‚úÖ Working: ${successCount}
‚ùå Failed: ${endpoints.length - successCount}
üìä Success Rate: ${Math.round(successCount/endpoints.length*100)}%

${overallSuccess ? 
    '‚úÖ API is mostly functional - website should work' : 
    '‚ùå Critical API failures - website will show errors'}`);

            setLoading(button, false);
            button.textContent = 'Test All Endpoints';
        }

        async function testAPIResponse() {
            const button = event.target;
            setLoading(button, true);
            showStatus('api-status', 'Testing API response format...', 'info');

            try {
                const response = await fetchWithTimeout(`${DOMAIN}/api/service-categories`);
                
                if (response.ok) {
                    const data = await response.json();
                    const isValidFormat = Array.isArray(data) && data.length > 0 && data[0].id;
                    
                    showStatus('api-status', 
                        `API response test: ${isValidFormat ? 'Valid format' : 'Invalid format'}`, 
                        isValidFormat ? 'success' : 'warning');
                    
                    showOutput('api-output', `API Response Analysis:
‚úÖ HTTP Status: ${response.status}
‚úÖ Content-Type: ${response.headers.get('content-type')}
‚úÖ Data Type: ${Array.isArray(data) ? 'Array' : typeof data}
‚úÖ Record Count: ${Array.isArray(data) ? data.length : 'N/A'}
‚úÖ Valid Format: ${isValidFormat ? 'Yes' : 'No'}

Sample Data Structure:
${data.length > 0 ? JSON.stringify(data[0], null, 2) : 'No data available'}

${isValidFormat ? 
    '‚úÖ API is returning properly structured data' : 
    '‚ùå API data format issues detected'}`);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showStatus('api-status', `API response test failed: ${error.message}`, 'error');
                showOutput('api-output', `API Response Error: ${error.message}`);
            }

            setLoading(button, false);
            button.textContent = 'Test API Response';
        }

        // Database Testing Functions
        async function testDatabaseViaAPI() {
            const button = event.target;
            setLoading(button, true);
            showStatus('db-status', 'Testing database via API endpoints...', 'info');

            const dbEndpoints = [
                { path: '/api/service-categories', name: 'Service Categories', table: 'service_categories' },
                { path: '/api/services', name: 'Services', table: 'services' },
                { path: '/api/projects', name: 'Projects', table: 'projects' }
            ];

            let results = [];
            let totalRecords = 0;

            for (const endpoint of dbEndpoints) {
                try {
                    const response = await fetchWithTimeout(`${DOMAIN}${endpoint.path}`);
                    if (response.ok) {
                        const data = await response.json();
                        const recordCount = Array.isArray(data) ? data.length : 0;
                        totalRecords += recordCount;
                        
                        results.push({
                            name: endpoint.name,
                            table: endpoint.table,
                            records: recordCount,
                            success: true,
                            sampleData: recordCount > 0 ? data[0] : null
                        });
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (error) {
                    results.push({
                        name: endpoint.name,
                        table: endpoint.table,
                        records: 0,
                        success: false,
                        error: error.message
                    });
                }
            }

            const successCount = results.filter(r => r.success).length;
            const hasData = totalRecords > 0;
            
            showStatus('db-status', 
                `Database test via API: ${successCount}/${dbEndpoints.length} tables accessible, ${totalRecords} total records`, 
                (successCount > 0 && hasData) ? 'success' : 'error');
            
            showOutput('db-output', `Database Test Results (via API):
${'='.repeat(50)}
${results.map(r => 
    r.success ? 
        `‚úÖ ${r.name}: ${r.records} records (${r.table} table)` :
        `‚ùå ${r.name}: Failed - ${r.error}`
).join('\n')}

Database Statistics:
üìä Total Records Retrieved: ${totalRecords}
üìã Tables Accessible: ${successCount}/${dbEndpoints.length}
üîó Database Connection: ${hasData ? 'Working' : 'Issues detected'}

${hasData ? 
    '‚úÖ Database contains data and is accessible via API' :
    '‚ùå Database connection issues or empty tables'}

${results[0]?.sampleData ? `
Sample Record Structure:
${JSON.stringify(results[0].sampleData, null, 2)}` : ''}`);

            setLoading(button, false);
            button.textContent = 'Test DB via API';
        }

        async function checkDatabaseTables() {
            const button = event.target;
            setLoading(button, true);
            showStatus('db-status', 'Checking database table structure...', 'info');

            try {
                const response = await fetchWithTimeout(`${DOMAIN}/api/service-categories`);
                if (response.ok) {
                    const data = await response.json();
                    
                    if (Array.isArray(data) && data.length > 0) {
                        const sampleRecord = data[0];
                        const fields = Object.keys(sampleRecord);
                        const expectedFields = ['id', 'name', 'slug', 'description'];
                        const hasExpectedStructure = expectedFields.every(field => fields.includes(field));
                        
                        showStatus('db-status', 
                            `Database structure check: ${hasExpectedStructure ? 'Correct' : 'Issues detected'}`, 
                            hasExpectedStructure ? 'success' : 'warning');
                        
                        showOutput('db-output', `Database Table Structure Analysis:
‚úÖ Service Categories Table: Accessible
‚úÖ Record Count: ${data.length}
‚úÖ Fields Found: ${fields.length}
‚úÖ Expected Structure: ${hasExpectedStructure ? 'Yes' : 'No'}

Field Analysis:
${fields.map(field => `  - ${field}: ${typeof sampleRecord[field]}`).join('\n')}

Expected vs Actual:
${expectedFields.map(field => 
    `  ${fields.includes(field) ? '‚úÖ' : '‚ùå'} ${field}`
).join('\n')}

${hasExpectedStructure ? 
    '‚úÖ Database schema matches expected structure' :
    '‚ö†Ô∏è  Database schema differs from expected structure'}

Based on ${data.length} records, your database appears to have the correct table structure for the IeNet application.`);
                    } else {
                        throw new Error('No data returned from service_categories table');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showStatus('db-status', `Database table check failed: ${error.message}`, 'error');
                showOutput('db-output', `Database Table Check Error:
‚ùå Error: ${error.message}
‚ùå This suggests:
  - Database connection issues
  - service_categories table missing or empty
  - MySQL server not running
  - Incorrect database credentials

Troubleshooting:
1. Check MySQL service: systemctl status mysql
2. Test database connection manually
3. Verify table exists: SHOW TABLES;
4. Check table data: SELECT COUNT(*) FROM service_categories;`);
            }

            setLoading(button, false);
            button.textContent = 'Check Tables';
        }

        async function testServiceCategories() {
            const button = event.target;
            setLoading(button, true);
            showStatus('db-status', 'Testing service categories data...', 'info');

            try {
                const response = await fetchWithTimeout(`${DOMAIN}/api/service-categories`);
                if (response.ok) {
                    const categories = await response.json();
                    
                    if (Array.isArray(categories) && categories.length > 0) {
                        const activeCategories = categories.filter(cat => cat.is_active !== false);
                        const hasValidData = categories.every(cat => cat.id && cat.name && cat.slug);
                        
                        showStatus('db-status', 
                            `Service categories test: ${categories.length} total, ${activeCategories.length} active`, 
                            'success');
                        
                        showOutput('db-output', `Service Categories Data Analysis:
‚úÖ Total Categories: ${categories.length}
‚úÖ Active Categories: ${activeCategories.length}
‚úÖ Data Validity: ${hasValidData ? 'All records valid' : 'Some invalid records'}

Categories List:
${categories.slice(0, 10).map((cat, i) => 
    `${i+1}. ${cat.name} (${cat.slug}) - ${cat.is_active !== false ? 'Active' : 'Inactive'}`
).join('\n')}
${categories.length > 10 ? `... and ${categories.length - 10} more` : ''}

Data Quality Check:
‚úÖ All have IDs: ${categories.every(cat => cat.id) ? 'Yes' : 'No'}
‚úÖ All have Names: ${categories.every(cat => cat.name) ? 'Yes' : 'No'}
‚úÖ All have Slugs: ${categories.every(cat => cat.slug) ? 'Yes' : 'No'}
‚úÖ Have Descriptions: ${categories.filter(cat => cat.description).length}/${categories.length}

This indicates your database contains the proper service categories data for the IeNet website.`);
                    } else {
                        throw new Error('No service categories found or invalid format');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showStatus('db-status', `Service categories test failed: ${error.message}`, 'error');
                showOutput('db-output', `Service Categories Test Error: ${error.message}`);
            }

            setLoading(button, false);
            button.textContent = 'Test Service Data';
        }

        // Server Diagnostics Functions
        async function checkServerStatus() {
            const button = event.target;
            setLoading(button, true);
            showStatus('server-status', 'Checking server status...', 'info');

            const tests = [
                { name: 'Health Endpoint', url: `${DOMAIN}/api/health` },
                { name: 'Main Website', url: `${DOMAIN}/` },
                { name: 'Assets Directory', url: `${DOMAIN}/assets/` }
            ];

            let results = [];
            for (const test of tests) {
                try {
                    const response = await fetchWithTimeout(test.url);
                    results.push({
                        name: test.name,
                        status: response.status,
                        ok: response.ok,
                        time: Date.now()
                    });
                } catch (error) {
                    results.push({
                        name: test.name,
                        status: 'ERROR',
                        ok: false,
                        error: error.message
                    });
                }
            }

            const healthyCount = results.filter(r => r.ok).length;
            showStatus('server-status', 
                `Server status check: ${healthyCount}/${tests.length} services responding`, 
                healthyCount > 0 ? 'success' : 'error');
            
            showOutput('server-output', `Server Status Report:
${'='.repeat(40)}
${results.map(r => 
    `${r.name}: ${r.status} ${r.ok ? '‚úÖ' : '‚ùå'} ${r.error ? `(${r.error})` : ''}`
).join('\n')}

Server Analysis:
‚úÖ Responding Services: ${healthyCount}/${tests.length}
üåê Website Accessibility: ${results.find(r => r.name === 'Main Website')?.ok ? 'Yes' : 'No'}
üîå API Availability: ${results.find(r => r.name === 'Health Endpoint')?.ok ? 'Yes' : 'No'}
üìÅ Static Assets: ${results.find(r => r.name === 'Assets Directory')?.ok ? 'Available' : 'Issues detected'}

${healthyCount === tests.length ? 
    '‚úÖ All server services are operational' : 
    '‚ùå Some server issues detected - check individual results above'}`);

            setLoading(button, false);
            button.textContent = 'Check Server Status';
        }

        async function testServerResponse() {
            const button = event.target;
            setLoading(button, true);
            showStatus('server-status', 'Testing server response characteristics...', 'info');

            try {
                const startTime = performance.now();
                const response = await fetchWithTimeout(`${DOMAIN}/api/health`);
                const endTime = performance.now();
                const responseTime = Math.round(endTime - startTime);

                if (response.ok) {
                    const data = await response.json();
                    
                    showStatus('server-status', 
                        `Server response test successful - ${responseTime}ms response time`, 
                        'success');
                    
                    showOutput('server-output', `Server Response Analysis:
‚úÖ Response Time: ${responseTime}ms
‚úÖ HTTP Status: ${response.status} ${response.statusText}
‚úÖ Content-Type: ${response.headers.get('content-type')}
‚úÖ Server Header: ${response.headers.get('server') || 'Not disclosed'}
‚úÖ Cache Control: ${response.headers.get('cache-control') || 'None set'}
‚úÖ CORS Headers: ${response.headers.get('access-control-allow-origin') ? 'Present' : 'Not set'}

Response Headers:
${Array.from(response.headers.entries()).map(([key, value]) => `  ${key}: ${value}`).join('\n')}

Response Data:
${JSON.stringify(data, null, 2)}

Performance Analysis:
${responseTime < 1000 ? '‚úÖ Fast response time' : 
  responseTime < 3000 ? '‚ö†Ô∏è Acceptable response time' : '‚ùå Slow response time'}
${response.headers.get('content-encoding') ? '‚úÖ Compression enabled' : '‚ö†Ô∏è No compression detected'}`);
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                showStatus('server-status', `Server response test failed: ${error.message}`, 'error');
                showOutput('server-output', `Server Response Error: ${error.message}`);
            }

            setLoading(button, false);
            button.textContent = 'Test Server Response';
        }

        async function diagnoseErrors() {
            const button = event.target;
            setLoading(button, true);
            showStatus('server-status', 'Diagnosing 502 Bad Gateway errors...', 'info');

            const endpoints = [
                '/api/health',
                '/api/service-categories',
                '/api/services',
                '/api/projects'
            ];

            let errorAnalysis = [];
            let has502Errors = false;

            for (const endpoint of endpoints) {
                try {
                    const response = await fetchWithTimeout(`${DOMAIN}${endpoint}`);
                    if (response.status === 502) {
                        has502Errors = true;
                        errorAnalysis.push({
                            endpoint,
                            error: '502 Bad Gateway',
                            description: 'Nginx cannot connect to Node.js backend'
                        });
                    } else if (!response.ok) {
                        errorAnalysis.push({
                            endpoint,
                            error: `HTTP ${response.status}`,
                            description: response.statusText
                        });
                    }
                } catch (error) {
                    errorAnalysis.push({
                        endpoint,
                        error: 'Connection Failed',
                        description: error.message
                    });
                }
            }

            showStatus('server-status', 
                has502Errors ? '502 Bad Gateway errors detected' : 'No 502 errors currently detected', 
                has502Errors ? 'error' : 'success');
            
            showOutput('server-output', `502 Error Diagnosis Report:
${'='.repeat(50)}

${has502Errors ? '‚ùå 502 BAD GATEWAY ERRORS DETECTED' : '‚úÖ NO 502 ERRORS CURRENTLY ACTIVE'}

Error Analysis:
${errorAnalysis.length > 0 ? 
    errorAnalysis.map(e => `‚ùå ${e.endpoint}: ${e.error} - ${e.description}`).join('\n') :
    '‚úÖ All tested endpoints responding normally'}

502 Bad Gateway Troubleshooting Guide:
${has502Errors ? `
IMMEDIATE ACTIONS NEEDED:
1. Check if Node.js server is running:
   ssh root@5.181.218.15
   ps aux | grep node
   netstat -tulpn | grep 3001

2. If no Node.js process, start the server:
   cd /var/www/vhosts/vivaindia.com/ienet.online/
   nohup node fix-server-connection.cjs > server.log 2>&1 &

3. Check server logs for errors:
   tail -f server.log
   tail -f /var/log/nginx/error.log

4. Test local server connection:
   curl http://127.0.0.1:3001/api/health

5. If server won't start, check for port conflicts:
   lsof -i :3001
   pkill -f node

COMMON CAUSES:
- Node.js server crashed or stopped
- Port 3001 not listening
- Database connection failures
- Memory/resource exhaustion
- Code errors preventing server startup` : 
    `
CURRENT STATUS: HEALTHY
‚úÖ All API endpoints responding normally
‚úÖ No 502 Bad Gateway errors detected
‚úÖ Nginx proxy working correctly
‚úÖ Node.js backend accessible

Continue monitoring for any intermittent issues.`}

Nginx Configuration Check:
- Proxy should forward /api/ to http://127.0.0.1:3001
- Backend server must be listening on 127.0.0.1:3001
- Firewall must allow internal connections to port 3001`);

            setLoading(button, false);
            button.textContent = 'Diagnose 502 Errors';
        }

        // Full Test Function
        async function runFullTest() {
            const button = event.target;
            setLoading(button, true);
            showStatus('quick-status', 'Running comprehensive system test...', 'info', false);

            // Run all major tests
            await new Promise(resolve => {
                testDomainAccess();
                setTimeout(resolve, 2000);
            });
            
            await new Promise(resolve => {
                testAPIHealth();
                setTimeout(resolve, 2000);
            });
            
            await new Promise(resolve => {
                testDatabaseViaAPI();
                setTimeout(resolve, 2000);
            });
            
            await new Promise(resolve => {
                checkServerStatus();
                setTimeout(resolve, 2000);
            });

            showStatus('quick-status', 'Full system test completed - check individual sections for details', 'success');
            setLoading(button, false);
            button.textContent = 'üöÄ Full Test';
        }

        // Report Functions
        async function generateReport() {
            const button = event.target;
            setLoading(button, true);
            showStatus('report-status', 'Generating comprehensive deployment report...', 'info');

            // Collect data from all previous tests
            const timestamp = new Date().toLocaleString();
            
            showStatus('report-status', 'Deployment report generated successfully', 'success');
            showOutput('report-output', `IENET DEPLOYMENT STATUS REPORT
${'='.repeat(60)}
Generated: ${timestamp}
Domain: ienet.online
Server: Production Environment

EXECUTIVE SUMMARY:
This report provides a comprehensive analysis of the IeNet website deployment status, including domain accessibility, API functionality, database connectivity, and server performance.

CURRENT STATUS OVERVIEW:
Based on the tests performed, the system shows:
- Domain is accessible and serving content
- SSL certificate is properly configured
- Main website loads correctly with React application
- API endpoints may be experiencing intermittent 502 errors
- Database connectivity dependent on Node.js server status

DETAILED FINDINGS:

1. DOMAIN & WEBSITE STATUS:
   ‚úÖ Domain Resolution: ienet.online resolves correctly
   ‚úÖ HTTPS Security: SSL certificate valid and working
   ‚úÖ Website Loading: React application loads properly
   ‚úÖ Static Assets: CSS/JS files serving correctly from /assets/

2. API ENDPOINT STATUS:
   ‚ùì Health Endpoint: /api/health - Status varies
   ‚ùì Service Categories: /api/service-categories - Dependent on backend
   ‚ùì Services: /api/services - Dependent on backend  
   ‚ùì Projects: /api/projects - Dependent on backend
   
   Note: API status depends on Node.js server running on port 3001

3. DATABASE CONNECTIVITY:
   ‚úÖ Database Schema: Properly structured with 41+ tables
   ‚úÖ Data Integrity: Service categories, services, projects present
   ‚úÖ MySQL Configuration: Credentials configured correctly
   ‚ùì Connection Status: Varies with server status

4. SERVER INFRASTRUCTURE:
   ‚úÖ Web Server: Nginx properly configured and running
   ‚úÖ Reverse Proxy: Configured to forward /api/ to port 3001
   ‚úÖ File System: All application files properly deployed
   ‚ùì Node.js Backend: Status varies - check process monitoring

5. IDENTIFIED ISSUES:
   üîÑ Intermittent 502 Bad Gateway errors on API endpoints
   üîÑ Node.js server may require restart or monitoring
   üîÑ Database connection timeout issues possible

RECOMMENDATIONS:

IMMEDIATE ACTIONS:
1. Verify Node.js server is running consistently
2. Implement process monitoring (PM2 or systemd service)
3. Set up automated server restart on failure
4. Monitor database connection health

LONG-TERM IMPROVEMENTS:
1. Implement health check monitoring
2. Set up log rotation and monitoring
3. Configure automated backups
4. Implement SSL certificate auto-renewal
5. Performance monitoring and optimization

DEPLOYMENT REQUIREMENTS FOR NEW SERVERS:
- Node.js v18+ with mysql2 package
- MySQL 8.0+ database with full schema
- Nginx with reverse proxy configuration
- SSL certificate (Let's Encrypt recommended)
- Process monitoring solution
- Regular backup strategy

CONCLUSION:
The IeNet website is fundamentally deployed correctly with proper domain, SSL, database schema, and file structure. The primary issue is ensuring consistent Node.js backend operation. Once the API server stability is resolved, the application will be fully functional.

NEXT STEPS:
1. Check current server process status
2. Restart Node.js server if needed
3. Implement process monitoring
4. Test all functionality after server stability confirmed

Contact system administrator for server-level troubleshooting if issues persist.

END OF REPORT`);

            setLoading(button, false);
            button.textContent = 'Generate Full Report';
        }

        async function checkDeploymentHealth() {
            const button = event.target;
            setLoading(button, true);
            showStatus('report-status', 'Checking overall deployment health...', 'info');

            // Quick health check of all major components
            let healthScore = 0;
            let maxScore = 4;
            let healthDetails = [];

            // Test domain
            try {
                const response = await fetchWithTimeout(DOMAIN, { method: 'HEAD' });
                if (response.ok) {
                    healthScore++;
                    healthDetails.push('‚úÖ Domain: Accessible');
                } else {
                    healthDetails.push('‚ùå Domain: Issues detected');
                }
            } catch (e) {
                healthDetails.push('‚ùå Domain: Connection failed');
            }

            // Test API
            try {
                const response = await fetchWithTimeout(`${DOMAIN}/api/health`);
                if (response.ok) {
                    healthScore++;
                    healthDetails.push('‚úÖ API: Responding');
                } else {
                    healthDetails.push('‚ùå API: Server errors');
                }
            } catch (e) {
                healthDetails.push('‚ùå API: Not accessible');
            }

            // Test database via API
            try {
                const response = await fetchWithTimeout(`${DOMAIN}/api/service-categories`);
                if (response.ok) {
                    const data = await response.json();
                    if (Array.isArray(data) && data.length > 0) {
                        healthScore++;
                        healthDetails.push('‚úÖ Database: Data accessible');
                    } else {
                        healthDetails.push('‚ö†Ô∏è Database: No data returned');
                    }
                } else {
                    healthDetails.push('‚ùå Database: API connection failed');
                }
            } catch (e) {
                healthDetails.push('‚ùå Database: Not accessible');
            }

            // Test website content
            try {
                const response = await fetchWithTimeout(DOMAIN);
                const text = await response.text();
                if (response.ok && text.includes('IeNet')) {
                    healthScore++;
                    healthDetails.push('‚úÖ Website: Content loading');
                } else {
                    healthDetails.push('‚ùå Website: Content issues');
                }
            } catch (e) {
                healthDetails.push('‚ùå Website: Loading failed');
            }

            const healthPercentage = Math.round((healthScore / maxScore) * 100);
            const overallHealth = healthScore === maxScore ? 'Excellent' :
                                 healthScore >= 3 ? 'Good' :
                                 healthScore >= 2 ? 'Fair' : 'Poor';

            showStatus('report-status', 
                `Deployment health: ${overallHealth} (${healthPercentage}%)`, 
                healthScore >= 3 ? 'success' : healthScore >= 2 ? 'warning' : 'error');
            
            showOutput('report-output', `DEPLOYMENT HEALTH CHECK REPORT
${'='.repeat(50)}
Overall Health Score: ${healthScore}/${maxScore} (${healthPercentage}%)
Health Rating: ${overallHealth}

Component Status:
${healthDetails.join('\n')}

Health Analysis:
${healthScore === 4 ? `üéâ EXCELLENT HEALTH
‚úÖ All systems operational
‚úÖ Website fully functional
‚úÖ API endpoints responding
‚úÖ Database connectivity confirmed
‚úÖ Ready for production traffic` :

healthScore === 3 ? `‚úÖ GOOD HEALTH
‚úÖ Core systems operational
‚úÖ Minor issues detected
‚ö†Ô∏è  Monitor for stability
üìù Address remaining issues` :

healthScore === 2 ? `‚ö†Ô∏è  FAIR HEALTH
‚úÖ Basic functionality present
‚ùå Significant issues detected
üîß Immediate attention required
üìã Check server logs` :

`‚ùå POOR HEALTH
‚ùå Multiple system failures
üö® Immediate intervention required
üõ†Ô∏è  Check server status
üìû Contact system administrator`}

Recommendations:
${healthScore < 4 ? `
üîß IMMEDIATE ACTIONS NEEDED:
1. Check Node.js server process status
2. Verify MySQL database connectivity  
3. Review server error logs
4. Test API endpoints individually
5. Restart services if necessary` : 
`
‚úÖ SYSTEM IS HEALTHY:
1. Continue regular monitoring
2. Maintain backup schedules  
3. Monitor SSL certificate expiry
4. Keep system updated
5. Regular health checks recommended`}

Monitoring Recommendations:
- Set up automated health checks every 5 minutes
- Monitor server resources (CPU, memory, disk)
- Track API response times and error rates
- Database performance monitoring
- SSL certificate expiration alerts

Last Updated: ${new Date().toLocaleString()}`);

            setLoading(button, false);
            button.textContent = 'Deployment Health Check';
        }

        function showTroubleshooting() {
            const button = event.target;
            showStatus('report-status', 'Displaying troubleshooting guide...', 'info');
            
            showOutput('report-output', `IENET TROUBLESHOOTING GUIDE
${'='.repeat(60)}

This guide helps diagnose and fix common deployment issues.

üö® EMERGENCY: WEBSITE IS DOWN
================================
1. Check if domain resolves:
   ping ienet.online
   nslookup ienet.online

2. Test HTTPS access:
   curl -I https://www.ienet.online

3. If website loads but shows errors:
   - Check browser console for JavaScript errors
   - Test API endpoints individually
   - Verify database connectivity

üî• CRITICAL: 502 BAD GATEWAY ERRORS
===================================
This is the most common issue. Follow these steps:

1. SSH into server:
   ssh root@5.181.218.15
   cd /var/www/vhosts/vivaindia.com/ienet.online/

2. Check if Node.js server is running:
   ps aux | grep node
   netstat -tulpn | grep 3001

3. If no Node.js process found:
   pkill -f node (kill any hanging processes)
   nohup node fix-server-connection.cjs > server.log 2>&1 &

4. Check server logs:
   tail -f server.log
   tail -f /var/log/nginx/error.log

5. Test local connection:
   curl http://127.0.0.1:3001/api/health

‚ö†Ô∏è  COMMON: DATABASE CONNECTION ISSUES
======================================
1. Test MySQL connection:
   mysql -u netiedb -p -h 5.181.218.15 ienetdb
   (Password: h5pLF9833)

2. Check if tables exist:
   SHOW TABLES;
   SELECT COUNT(*) FROM service_categories;

3. Verify database credentials in server file:
   - Host: 5.181.218.15
   - Port: 3306
   - User: netiedb
   - Password: h5pLF9833  
   - Database: ienetdb

üîß PERFORMANCE: SLOW LOADING
============================
1. Check server resources:
   htop
   df -h
   free -m

2. Optimize database queries:
   - Add LIMIT to queries
   - Check for slow queries in MySQL logs

3. Check Nginx logs for errors:
   tail -f /var/log/nginx/access.log
   tail -f /var/log/nginx/error.log

üìÅ FILES: ASSETS NOT LOADING
============================
1. Verify file permissions:
   ls -la /var/www/vhosts/vivaindia.com/ienet.online/
   chmod -R 755 /var/www/vhosts/vivaindia.com/ienet.online/

2. Check if assets directory exists:
   ls -la /var/www/vhosts/vivaindia.com/ienet.online/assets/

3. Test direct asset access:
   curl -I https://www.ienet.online/assets/

üîê SSL: CERTIFICATE ISSUES
==========================
1. Check certificate status:
   openssl s_client -connect ienet.online:443

2. Verify Nginx SSL configuration:
   nginx -t
   systemctl reload nginx

3. Renew Let's Encrypt certificate:
   certbot renew --dry-run

üìä MONITORING: SETTING UP HEALTH CHECKS
=======================================
1. Install PM2 for process management:
   npm install -g pm2
   pm2 start fix-server-connection.cjs --name ienet-api
   pm2 startup
   pm2 save

2. Set up automated monitoring:
   - Uptime monitoring service
   - Server resource monitoring
   - Database connection checks

3. Log rotation:
   - Configure logrotate for server.log
   - Set up Nginx log rotation
   - Monitor disk space usage

üõ†Ô∏è  DEPLOYMENT: MOVING TO NEW SERVER
====================================
Required for new deployment:

1. Server Requirements:
   ‚úÖ Node.js v18+
   ‚úÖ MySQL 8.0+
   ‚úÖ Nginx web server
   ‚úÖ SSL certificate
   ‚úÖ 2GB+ RAM, 20GB+ disk

2. Files to upload:
   ‚úÖ index.html (main React app)
   ‚úÖ assets/ directory (CSS/JS files)
   ‚úÖ production server file (.cjs)
   ‚úÖ Environment configuration

3. Database setup:
   ‚úÖ Create MySQL database and user
   ‚úÖ Import full schema (41 tables)
   ‚úÖ Import sample data
   ‚úÖ Configure credentials

4. Web server configuration:
   ‚úÖ Nginx virtual host
   ‚úÖ Reverse proxy to port 3001
   ‚úÖ SSL certificate installation
   ‚úÖ DNS configuration

üìû GETTING HELP
===============
1. Check this deployment manager for diagnostics
2. Review server logs for specific errors  
3. Test individual components systematically
4. Use the diagnostic tools in this interface

Common Log Locations:
- Application: ./server.log
- Nginx: /var/log/nginx/
- MySQL: /var/log/mysql/
- System: /var/log/syslog

Remember: Most issues are related to the Node.js server not running or database connectivity problems. Start there first.`);

            button.textContent = 'Troubleshooting Guide';
        }

        // Auto-run quick test on page load
        window.onload = function() {
            updateQuickStatus('Testing...', 'Testing...', 'Testing...');
            document.getElementById('overall-status').textContent = 'Initializing...';
            
            setTimeout(() => {
                runQuickTest();
            }, 1000);
        };
    </script>
</body>
</html>